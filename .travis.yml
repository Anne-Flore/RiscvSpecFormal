language: generic
sudo: true
dist: xenial

cache:
  directories:
  - $HOME/haskell-files
  - $HOME/riscv-tests-binaries
  - $HOME/haskell-binary
  - $HOME/generate-verilog

jobs:
  include:
  # Generate Haskell Files by compiling Coq source code
  - stage: generatehaskell
    before_install:
    - curl -sL https://raw.githubusercontent.com/ocaml/opam/master/shell/install.sh > install.sh
    - yes '' | bash install.sh && rm install.sh
    - opam init --auto-setup --yes --jobs=8 --compiler=4.07.1+flambda --disable-sandboxing
    - eval $(opam env)
    - echo 'eval $(opam env)' >> ~/.bashrc
    - opam repository add --all-switches --set-default coq-released https://coq.inria.fr/opam/released
    - opam update -y
    - opam install -y -j 8 opam-depext
    - travis_wait 60 opam install -j 8 coq.8.9.0 --yes

    script:
    - make
    - rm -rf $HOME/haskell-files
    - cp ./*.hs $HOME/haskell-files


  # Generate riscv-tests binaries
  - before_install:
    - wget https://static.dev.sifive.com/dev-tools/riscv64-unknown-elf-gcc-8.2.0-2019.02.0-x86_64-linux-ubuntu14.tar.gz
    - tar -xzf riscv64-unknown-elf-gcc-8.2.0-2019.02.0-x86_64-linux-ubuntu14.tar.gz
    - export PATH=$PATH:$(pwd)/riscv64-unknown-elf-gcc-8.2.0-2019.02.0-x86_64-linux-ubuntu14/bin
    - git clone https://github.com/riscv/riscv-tests.git

    script:
    - cd riscv-tests
    - git submodule update --init --recursive
    - autoconf
    - rm -rf $HOME/riscv-tests-binaries
    - ./configure --prefix=$HOME/riscv-tests-binaries
    - sed -i -e "s/0x80000000/0x00000000/g" ./env/p/link.ld
    - make -j
    - make install


  # Install verilator
  - before_install:
    - git clone http://git.veripool.org/git/verilator

    script:
    - cd verilator
    - autoconf
    - rm -rf $HOME/verilator-binary
    - ./configure --prefix=$HOME/verilator-binary
    - make -j 4
    - make install


  # Compile Haskell files into a Binary
  - stage: compilehaskell
    before_install:
    - sudo apt-get install ghc
    - sudo apt-get install cabal-install
    - cabal install mtl-2.2.2
    - cp $HOME/haskell-files ./
    - rm -rf $HOME/haskell-binary

    script:
    - echo "  model32" >> Target.hs
    - ghc -j -v +RTS -K128m -RTS -rtsopts -O0 --make --static -o $HOME/haskell-binary/Print32 ./Kami/PrettyPrintVerilog.hs
    script:
    - echo "  model64" >> Target.hs
    - ghc -j -v +RTS -K128m -RTS -rtsopts -O0 --make --static -o $HOME/haskell-binary/Print64 ./Kami/PrettyPrintVerilog.hs



  # Generate Verilog file from Haskell Binary
  - stage: generateverilog
    script:
    - rm -rf $HOME/verilog-file
    - $HOME/haskell-binary/Print32 > $HOME/verilog-file/System32.sv
    script:
    - rm -rf $HOME/verilog-file
    - $HOME/haskell-binary/Print64 > $HOME/verilog-file/System64.sv

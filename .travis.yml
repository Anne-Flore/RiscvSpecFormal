language: generic
sudo: true
dist: xenial

cache:
  directories:
  - $HOME/haskell-files
  - $HOME/riscv-tests-binaries
  - $HOME/haskell-binary
  - $HOME/generate-verilog

jobs:
  include:
  # Generate Haskell Files by compiling Coq source code
  - stage: generatehaskell
    before_install:
    - sudo add-apt-repository ppa:jgross-h/many-coq-versions --yes
    - sudo apt-get update
    - sudo apt-get install coq-8.9.0

    script:
    - make -j 4
    - rm -rf $HOME/haskell-files
    - mkdir $HOME/haskell-files
    - cp ./*.hs $HOME/haskell-files


  # Generate riscv-tests binaries
  - before_install:
    - wget https://static.dev.sifive.com/dev-tools/riscv64-unknown-elf-gcc-8.2.0-2019.02.0-x86_64-linux-ubuntu14.tar.gz
    - tar -xzf riscv64-unknown-elf-gcc-8.2.0-2019.02.0-x86_64-linux-ubuntu14.tar.gz
    - export PATH=$PATH:$(pwd)/riscv64-unknown-elf-gcc-8.2.0-2019.02.0-x86_64-linux-ubuntu14/bin
    - git clone https://github.com/riscv/riscv-tests.git

    script:
    - cd riscv-tests
    - git submodule update --init --recursive
    - autoconf
    - rm -rf $HOME/riscv-tests-binaries
    - ./configure --prefix=$HOME/riscv-tests-binaries
    - sed -i -e "s/0x80000000/0x00000000/g" ./env/p/link.ld
    - make -j
    - make install


  # Install verilator
  - before_install:
    - git clone http://git.veripool.org/git/verilator

    script:
    - cd verilator
    - autoconf
    - rm -rf $HOME/verilator-binary
    - ./configure --prefix=$HOME/verilator-binary
    - make -j 4
    - make install


  # Compile Haskell files into a Binary
  - stage: compilehaskell
    before_install:
    - sudo apt-get install ghc
    - sudo apt-get install cabal-install
    - cabal update
    - cabal install mtl-2.2.2
    - cp $HOME/haskell-files ./
    - rm -rf $HOME/haskell-binary

    script:
    - echo "  model32" >> Target.hs
    - ghc -j -v +RTS -K128m -RTS -rtsopts -O0 --make --static -o $HOME/haskell-binary/Print32 ./Kami/PrettyPrintVerilog.hs
    script:
    - echo "  model64" >> Target.hs
    - ghc -j -v +RTS -K128m -RTS -rtsopts -O0 --make --static -o $HOME/haskell-binary/Print64 ./Kami/PrettyPrintVerilog.hs



  # Generate Verilog file from Haskell Binary
  - stage: generateverilog

    script:
    - rm -rf $HOME/verilog-file
    - $HOME/haskell-binary/Print32 > $HOME/verilog-file/System32.sv
    script:
    - rm -rf $HOME/verilog-file
    - $HOME/haskell-binary/Print64 > $HOME/verilog-file/System64.sv
